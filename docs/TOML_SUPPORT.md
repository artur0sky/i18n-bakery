# TOML Format Support

This document describes the TOML format support in the i18n-bakery baker package.

## Overview

The baker package now supports writing translation files in **TOML (Tom's Obvious, Minimal Language)** format, in addition to JSON. TOML is a configuration file format that's easy to read due to obvious semantics and is designed to map unambiguously to a hash table.

### Key Features

- ‚úÖ **Zero External Dependencies** - Pure TypeScript implementation
- ‚úÖ **TOML v1.0.0 Compliant** - Follows the official TOML specification
- ‚úÖ **Security First** - Prototype pollution prevention built-in
- ‚úÖ **Nested & Flat Structures** - Support for both file organization styles
- ‚úÖ **Round-trip Integrity** - Data preserved through write-read cycles
- ‚úÖ **Pretty Printing** - Configurable formatting for readability

## Quick Start

### Basic Usage

```typescript
import { TOMLFileSaver } from "@i18n-bakery/baker";

// Create saver with nested structure
const saver = new TOMLFileSaver("./locales", "nested");

// Save translations
await saver.save("en", "common", "title", "Welcome");
await saver.save("en", "common", "greeting", "Hello, {{name}}!");
```

### Advanced Usage with TOMLFileWriter

```typescript
import { TOMLFileWriter, NodeFileSystemManager } from "@i18n-bakery/baker";

const fsManager = new NodeFileSystemManager();
const writer = new TOMLFileWriter(fsManager, {
  format: "toml",
  prettyPrint: true,
  indentSize: 2,
  createDirectories: true,
});

const content = {
  greeting: {
    variants: {
      default: {
        value: "Hello",
        variables: [],
        autoGenerated: true,
        timestamp: Date.now(),
      },
      name: {
        value: "Hello, {{name}}!",
        variables: ["name"],
        autoGenerated: false,
      },
    },
  },
};

await writer.write("./locales/en/common.toml", content);
```

## TOML Format Examples

### Simple Translation

```toml
[greeting.variants.default]
value = "Hello"
variables = []
autoGenerated = true
timestamp = 1234567890
```

### With Variables

```toml
[greeting.variants.name]
value = "Hello, {{name}}!"
variables = ["name"]
autoGenerated = false
```

### Multiple Variants

```toml
[meal.variants.default]
value = "{{meal}}"
variables = ["meal"]

[meal.variants.meal_price]
value = "{{meal}} - ${{price}}"
variables = ["meal", "price"]
```

## Architecture

Following **Clean Architecture** and **SOLID** principles:

### Domain Layer

- `FileWriter` interface - Port for file writing operations
- `TranslationFileContent` - Format-agnostic content structure

### Adapter Layer

- `TOMLFileWriter` - Implements `FileWriter` for TOML format
- `TOMLFileSaver` - Implements `TranslationSaver` for simple TOML operations

## Integration with TranslationFileManager

```typescript
import {
  TranslationFileManager,
  TOMLFileWriter,
  NodeFileSystemManager,
  DefaultKeyParser,
  FileSystemPathResolver,
  DefaultVariableDetector,
} from "@i18n-bakery/baker";

const fsManager = new NodeFileSystemManager();
const tomlWriter = new TOMLFileWriter(fsManager);

const manager = new TranslationFileManager({
  keyParser: new DefaultKeyParser(),
  pathResolver: new FileSystemPathResolver({
    baseDir: "./locales",
    extension: "toml", // Use .toml extension
  }),
  variableDetector: new DefaultVariableDetector(),
  fileWriter: tomlWriter,
  mergeMode: "append",
});

// Create or update translation
await manager.createOrUpdateEntry(
  "en",
  "orders:meal.title",
  "{{meal}} - ${{price}}",
  { meal: "Pizza", price: 12.99 }
);
```

## Configuration Options

### TOMLFileWriter Options

```typescript
interface FileWriterConfig {
  format: "toml"; // Output format
  prettyPrint?: boolean; // Enable pretty printing (default: true)
  indentSize?: number; // Indentation size (default: 2)
  createDirectories?: boolean; // Auto-create directories (default: true)
}
```

### TOMLFileSaver Options

```typescript
constructor(
  localesPath: string,         // Base path for locale files
  fileStructure: 'nested' | 'flat' = 'nested' // File structure mode
)
```

## Security Features

### Prototype Pollution Prevention

Both `TOMLFileWriter` and `TOMLFileSaver` include built-in protection against prototype pollution attacks:

```typescript
// Dangerous keys are automatically filtered out
const maliciousContent = {
  __proto__: {
    /* ... */
  }, // ‚ùå Filtered
  constructor: {
    /* ... */
  }, // ‚ùå Filtered
  prototype: {
    /* ... */
  }, // ‚ùå Filtered
  safeKey: {
    /* ... */
  }, // ‚úÖ Allowed
};
```

### File Extension Validation

```typescript
// Only .toml files are allowed
await writer.write("./locales/en/common.toml", content); // ‚úÖ OK
await writer.write("./locales/en/common.json", content); // ‚ùå Error
```

## JSON vs TOML Comparison

### JSON Format

```json
{
  "greeting": {
    "variants": {
      "default": {
        "value": "Hello",
        "variables": [],
        "autoGenerated": true
      }
    }
  }
}
```

### TOML Format

```toml
[greeting.variants.default]
value = "Hello"
variables = []
autoGenerated = true
```

### Advantages of TOML

1. **More Readable** - Less visual noise, clearer structure
2. **Better for Humans** - Easier to edit manually
3. **Comments Support** - Native comment support with `#`
4. **Type Safety** - Explicit types (strings, numbers, booleans)
5. **No Trailing Commas** - Less syntax errors
6. **Smaller Files** - Typically 15-25% smaller than JSON

## Migration from JSON to TOML

### Step 1: Update Configuration

```typescript
// Before
const pathResolver = new FileSystemPathResolver({
  baseDir: "./locales",
  extension: "json",
});

// After
const pathResolver = new FileSystemPathResolver({
  baseDir: "./locales",
  extension: "toml",
});
```

### Step 2: Update File Writer

```typescript
// Before
const writer = new JSONFileWriter(fsManager);

// After
const writer = new TOMLFileWriter(fsManager);
```

### Step 3: Convert Existing Files (Optional)

```typescript
import {
  JSONFileWriter,
  TOMLFileWriter,
  NodeFileSystemManager,
} from "@i18n-bakery/baker";

async function convertJsonToToml(jsonPath: string, tomlPath: string) {
  const fsManager = new NodeFileSystemManager();
  const jsonWriter = new JSONFileWriter(fsManager);
  const tomlWriter = new TOMLFileWriter(fsManager);

  const content = await jsonWriter.read(jsonPath);
  if (content) {
    await tomlWriter.write(tomlPath, content);
    console.log(`‚úÖ Converted ${jsonPath} ‚Üí ${tomlPath}`);
  }
}
```

## Best Practices

### 1. Choose the Right Structure

```typescript
// Nested - Better for organization
const nestedSaver = new TOMLFileSaver("./locales", "nested");
await nestedSaver.save("en", "app", "features.orders.title", "Orders");
// Creates: [features.orders] title = "Orders"

// Flat - Better for simple keys
const flatSaver = new TOMLFileSaver("./locales", "flat");
await flatSaver.save("en", "app", "title", "My App");
// Creates: title = "My App"
```

### 2. Use Consistent Formatting

```typescript
const writer = new TOMLFileWriter(fsManager, {
  prettyPrint: true, // Always use pretty printing
  indentSize: 2, // Consistent indentation
});
```

### 3. Use Append Mode for Safety

```typescript
const manager = new TranslationFileManager({
  // ... other config
  mergeMode: "append", // Prevent accidental overwrites
});
```

## Testing

Comprehensive test suites are included:

```bash
# Run all tests
pnpm test

# Run TOML-specific tests
pnpm test tomlFileWriter
pnpm test tomlFileSaver
```

### Test Coverage

- ‚úÖ Serialization and deserialization
- ‚úÖ Security (prototype pollution prevention)
- ‚úÖ Special character escaping
- ‚úÖ Round-trip integrity
- ‚úÖ Merge operations (append/replace)
- ‚úÖ Nested and flat structures
- ‚úÖ Multiple locales and namespaces
- ‚úÖ File system operations

**Results**: 38/38 tests passing (100%)

## Troubleshooting

### Issue: File not created

**Solution**: Ensure `createDirectories` is enabled:

```typescript
const writer = new TOMLFileWriter(fsManager, {
  createDirectories: true, // Enable auto-creation
});
```

### Issue: Special characters not escaped

**Solution**: The writer automatically escapes special characters. If you see raw characters, check your TOML viewer.

### Issue: Merge not working as expected

**Solution**: Check your merge mode:

```typescript
// Append mode - preserves existing
await writer.merge(path, content, "append");

// Replace mode - overwrites existing
await writer.merge(path, content, "replace");
```

## License

MIT ¬© Arturo S√°enz

---

**Made with üç© and zero dependencies**
